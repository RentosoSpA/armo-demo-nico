import{c as T,s as d,u as R,e as q,f as B,F as o,r as u,j as e,a as p,g as P,T as L,B as b,w as D,h as F,M as w,I as x}from"./index-BmXdxNCh.js";import{L as I}from"./lock-DxMjBuaL.js";/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const M=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["circle",{cx:"12",cy:"10",r:"3",key:"ilqhr7"}],["path",{d:"M7 20.662V19a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v1.662",key:"154egf"}]],k=T("circle-user",M),H=async l=>{try{const{data:r,error:n}=await d.from("user_invitations").select("*").eq("token",l).eq("status","pending").single();if(n||!r)return console.error("Invitation not found or expired:",n),null;if(new Date(r.expires_at)<new Date)return await d.from("user_invitations").update({status:"expired"}).eq("id",r.id),null;const{data:g,error:m}=await d.from("empresa").select("*").eq("id",r.empresa_id).single();return m||!g?(console.error("Company not found:",m),null):{...r,empresa:g}}catch(r){return console.error("Error verifying invitation:",r),null}},V=async l=>{try{const{error:r}=await d.from("user_invitations").update({status:"accepted",accepted_at:new Date().toISOString()}).eq("token",l).eq("status","pending");return r?(console.error("Error accepting invitation:",r),!1):!0}catch(r){return console.error("Exception accepting invitation:",r),!1}},{Title:E,Text:s,Paragraph:C}=L,N={admin:"Administrador",agent:"Agente",supervisor:"Supervisor",assistant:"Asistente"},W=()=>{const[l]=R(),r=q(),{message:n}=B.useApp(),[f]=o.useForm(),[g,m]=u.useState(!0),[z,y]=u.useState(!1),[a,_]=u.useState(null),[v,h]=u.useState(null);u.useEffect(()=>{const i=l.get("token");if(!i){h("Token de invitación no encontrado"),m(!1);return}A(i)},[l]);const A=async i=>{try{const t=await H(i);t?(_(t),f.setFieldsValue({email:t.email})):h("Invitación inválida o expirada")}catch(t){console.error("Error verifying token:",t),h("Error al verificar la invitación")}finally{m(!1)}},S=async i=>{if(a){y(!0);try{const{data:t,error:c}=await d.auth.signUp({email:a.email,password:i.password,options:{data:{full_name:i.nombre,company_name:a.empresa.nombre,email:a.email},emailRedirectTo:`${window.location.origin}/`}});if(c){console.error("Sign up error:",c),n.error(c.message||"Error al crear la cuenta");return}if(!t.user){n.error("Error al crear el usuario");return}const{error:j}=await d.from("user_roles").insert({user_id:t.user.id,role:a.role,empresa_id:a.empresa_id});if(j){console.error("Role assignment error:",j),n.error("Error al asignar rol");return}await V(a.token),n.success("¡Cuenta creada exitosamente! Redirigiendo..."),setTimeout(()=>{r("/")},2e3)}catch(t){console.error("Registration error:",t),n.error(t.message||"Error al procesar la invitación")}finally{y(!1)}}};return g?e.jsx("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"100vh",background:"linear-gradient(135deg, #667eea 0%, #764ba2 100%)"},children:e.jsxs(p,{style:{width:400,textAlign:"center"},children:[e.jsx(P,{size:"large"}),e.jsx(C,{style:{marginTop:20},children:"Verificando invitación..."})]})}):v||!a?e.jsx("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"100vh",background:"linear-gradient(135deg, #667eea 0%, #764ba2 100%)"},children:e.jsxs(p,{style:{width:500,textAlign:"center"},children:[e.jsx(E,{level:3,style:{color:"#ff4d4f"},children:"Invitación Inválida"}),e.jsx(C,{children:v||"La invitación no pudo ser verificada"}),e.jsx(b,{type:"primary",onClick:()=>r("/"),children:"Volver al inicio"})]})}):e.jsx("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"100vh",background:"linear-gradient(135deg, #667eea 0%, #764ba2 100%)",padding:"20px"},children:e.jsxs(p,{style:{width:"100%",maxWidth:600,boxShadow:"0 4px 12px rgba(0,0,0,0.15)"},children:[e.jsxs("div",{style:{textAlign:"center",marginBottom:30},children:[e.jsx("div",{style:{width:60,height:60,borderRadius:"50%",background:"linear-gradient(135deg, #667eea 0%, #764ba2 100%)",display:"flex",alignItems:"center",justifyContent:"center",margin:"0 auto 20px"},children:e.jsx(D,{size:32,color:"white"})}),e.jsx(E,{level:2,style:{marginBottom:10},children:"¡Bienvenido a RentOso!"}),e.jsx(s,{type:"secondary",children:"Has sido invitado a unirte a una empresa"})]}),e.jsxs(p,{style:{marginBottom:30,background:"linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%)",border:"none"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",marginBottom:12},children:[e.jsx(F,{size:20,style:{marginRight:8,color:"#667eea"}}),e.jsx(s,{strong:!0,children:"Empresa: "}),e.jsx(s,{style:{marginLeft:8},children:a.empresa.nombre})]}),e.jsxs("div",{style:{display:"flex",alignItems:"center",marginBottom:12},children:[e.jsx(w,{size:20,style:{marginRight:8,color:"#667eea"}}),e.jsx(s,{strong:!0,children:"Email: "}),e.jsx(s,{style:{marginLeft:8},children:a.email})]}),e.jsxs("div",{style:{display:"flex",alignItems:"center"},children:[e.jsx(k,{size:20,style:{marginRight:8,color:"#667eea"}}),e.jsx(s,{strong:!0,children:"Rol: "}),e.jsx(s,{style:{marginLeft:8},children:N[a.role]})]})]}),e.jsxs(o,{form:f,layout:"vertical",onFinish:S,requiredMark:"optional",children:[e.jsx(o.Item,{name:"email",label:"Email",children:e.jsx(x,{prefix:e.jsx(w,{size:18}),disabled:!0,size:"large"})}),e.jsx(o.Item,{name:"nombre",label:"Nombre completo",rules:[{required:!0,message:"Por favor ingresa tu nombre"},{min:2,message:"El nombre debe tener al menos 2 caracteres"}],children:e.jsx(x,{prefix:e.jsx(k,{size:18}),placeholder:"Tu nombre completo",size:"large"})}),e.jsx(o.Item,{name:"password",label:"Contraseña",rules:[{required:!0,message:"Por favor ingresa una contraseña"},{min:6,message:"La contraseña debe tener al menos 6 caracteres"}],children:e.jsx(x.Password,{prefix:e.jsx(I,{size:18}),placeholder:"Mínimo 6 caracteres",size:"large"})}),e.jsx(o.Item,{name:"confirmPassword",label:"Confirmar contraseña",dependencies:["password"],rules:[{required:!0,message:"Por favor confirma tu contraseña"},({getFieldValue:i})=>({validator(t,c){return!c||i("password")===c?Promise.resolve():Promise.reject(new Error("Las contraseñas no coinciden"))}})],children:e.jsx(x.Password,{prefix:e.jsx(I,{size:18}),placeholder:"Confirma tu contraseña",size:"large"})}),e.jsx(o.Item,{style:{marginBottom:0},children:e.jsx(b,{type:"primary",htmlType:"submit",loading:z,size:"large",block:!0,style:{background:"linear-gradient(135deg, #667eea 0%, #764ba2 100%)",border:"none",height:48},children:"Crear Cuenta y Aceptar Invitación"})})]}),e.jsx("div",{style:{marginTop:20,textAlign:"center"},children:e.jsx(s,{type:"secondary",style:{fontSize:12},children:"Al crear tu cuenta, aceptas los términos y condiciones de RentOso"})})]})})};export{W as AceptarInvitacion,W as default};
