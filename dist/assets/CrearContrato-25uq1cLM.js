import{e as V,u as X,f as G,r as s,j as a,B as b,G as Z,a as q,bW as M,bX as J,bE as Q,t as Y,bv as ee}from"./index-BmXdxNCh.js";import{g as te,d as ae,s as oe,m as ne,o as re}from"./contratosNewServiceMock-DGZkPxYE.js";const se=/\{\{\s*([a-zA-Z0-9_.]+)\s*\}\}/g;function ce(p,f){return p.replace(se,(c,x)=>{const m=x.split(".").reduce((u,g)=>u==null?void 0:u[g],f);return m!=null?String(m):`[[${x}]]`})}function P(p){return/\[\[[a-zA-Z0-9_.]+\]\]/.test(p)}const de=()=>{const p=V(),[f]=X(),{message:c,modal:x}=G.useApp(),m=f.get("contratoId"),u=f.get("propiedadId"),g=f.get("prospectoId"),[n,R]=s.useState(null),[d,L]=s.useState(null),[r,_]=s.useState(null),[v,z]=s.useState(!1),[y,O]=s.useState(""),[I,k]=s.useState(!0),[j,T]=s.useState({}),[C,E]=s.useState(null),w=s.useRef(null);s.useEffect(()=>{$()},[m,u,g]),s.useEffect(()=>{if(n&&d&&r){const e={propiedad:{titulo:d.titulo,direccion:d.direccion,ciudad:d.ciudad,canon_mensual:d.canon_mensual,moneda:d.moneda,dia_pago:d.dia_pago},prospecto:{nombre:r.nombre,doc:r.doc,telefono:r.telefono,email:r.email},fecha:{hoy:new Date().toLocaleDateString("es-ES",{day:"2-digit",month:"long",year:"numeric"})},empresa:{nombre:"Rentoso"}},o=ce(n.html,e);O(o)}},[n,d,r]);const $=async()=>{if(!m||!u||!g){c.error("Datos de contrato incompletos"),p("/contratos");return}try{k(!0);const[e,o]=await Promise.all([te(u),ae(g)]);if(!e||!o){c.error("No se pudo cargar los datos"),p("/contratos");return}const t={id:m,propiedadId:u,prospectoId:g,plantillaId:"mock",titulo:"Contrato de Arriendo",html:"<h1>CONTRATO DE ARRIENDO</h1><p>En la ciudad de [[propiedad.ciudad]], a [[fecha.hoy]], entre [[empresa.nombre]] y [[prospecto.nombre]], RUT [[prospecto.doc]], se celebra el presente contrato de arriendo sobre la propiedad ubicada en [[propiedad.direccion]].</p><p>El canon de arriendo mensual será de [[propiedad.moneda]] [[propiedad.canon_mensual]], pagadero el día [[propiedad.dia_pago]] de cada mes.</p>",estado:"Pendiente",createdAt:new Date().toISOString()};R(t),L(e),_(o)}catch{c.error("Error al cargar el contrato"),p("/contratos")}finally{k(!1)}},W=async()=>{if(n)try{await oe(n.id,n.html),c.success("Borrador guardado correctamente")}catch{c.error("Error al guardar el borrador")}},H=()=>{c.info("Generando PDF..."),setTimeout(()=>{window.print()},100)},B=()=>{if(!n)return;const e=new Blob([n.html],{type:"text/plain"}),o=URL.createObjectURL(e),t=document.createElement("a");t.href=o,t.download=`${n.titulo}.docx`,document.body.appendChild(t),t.click(),document.body.removeChild(t),URL.revokeObjectURL(o),c.success("Documento DOCX descargado")},F=async()=>{!n||!r||(P(y)?x.confirm({title:"Campos incompletos",content:"El contrato tiene campos sin completar. ¿Deseas enviarlo de todos modos?",okText:"Enviar",cancelText:"Cancelar",onOk:async()=>{await N()}}):await N())},N=async()=>{if(!(!n||!r))try{const e=await ne(n.id),o=`Hola ${r.nombre}, te comparto el contrato para revisión: ${e}`;r.telefono?(re(r.telefono,e,o),c.success("Abriendo WhatsApp...")):c.warning("El prospecto no tiene teléfono registrado")}catch{c.error("Error al generar el enlace")}},U=e=>{const o=e.target;if(o.classList.contains("editable-placeholder")&&!o.classList.contains("editing")){const t=o.getAttribute("data-key");t&&(E(t),setTimeout(()=>{const l=document.querySelector(`[data-key="${t}"]`);if(l){l.contentEditable="true",l.focus();const h=document.createRange();h.selectNodeContents(l);const i=window.getSelection();i==null||i.removeAllRanges(),i==null||i.addRange(h)}},0))}},A=e=>{const o=e.target,t=o.getAttribute("data-key");if(t){const l=o.textContent||"";T(h=>({...h,[t]:l})),o.contentEditable="false",E(null)}},S=e=>{if(e.key==="Enter"&&(e.preventDefault(),e.target.blur()),e.key==="Escape"){const o=e.target,t=o.getAttribute("data-key");if(t){const l=j[t]||`[[${t}]]`;o.textContent=l,o.contentEditable="false",E(null)}}},D=e=>e.replace(/\[\[([a-zA-Z0-9_.]+)\]\]/g,(o,t)=>{const l=j[t]||o,h=C===t;let i="editable-placeholder";return v&&(i+=" highlighted"),h&&(i+=" editing"),`<span class="${i}" data-key="${t}" contenteditable="${h}" onblur="handlePlaceholderBlur" onkeydown="handlePlaceholderKeyDown">${l}</span>`});s.useEffect(()=>{var o;const e=(o=w.current)==null?void 0:o.querySelectorAll(".editable-placeholder");return e==null||e.forEach(t=>{t.addEventListener("blur",A),t.addEventListener("keydown",S)}),()=>{e==null||e.forEach(t=>{t.removeEventListener("blur",A),t.removeEventListener("keydown",S)})}},[D(y),C]);const K=D(y);return I||!n||!d||!r?a.jsx("div",{className:"crear-contrato-loading",children:"Cargando..."}):a.jsxs("div",{className:"crear-contrato-container",children:[a.jsx("div",{className:"crear-contrato-header",children:a.jsx(b,{type:"text",icon:a.jsx(Z,{size:16}),onClick:()=>p("/contratos"),className:"back-button",children:"Volver a Contratos"})}),a.jsxs("div",{className:"crear-contrato-body",children:[a.jsx("div",{className:"document-section",children:a.jsx("div",{className:"document-wrapper",onClick:U,children:a.jsx("div",{className:"document-page",children:a.jsx("div",{ref:w,className:"document-content",dangerouslySetInnerHTML:{__html:K}})})})}),a.jsx("div",{className:"sidebar-section",children:a.jsx(q,{className:"sidebar-card",title:"Acciones",children:a.jsxs("div",{className:"sidebar-actions",children:[a.jsxs("div",{className:"contract-title",children:[a.jsx("h3",{children:n.titulo}),P(y)&&a.jsx("span",{className:"incomplete-badge",children:"Campos incompletos"})]}),a.jsxs("div",{className:"option-item",children:[a.jsx("span",{className:"option-label",children:"Resaltar campos"}),a.jsx(M,{checked:v,onChange:z})]}),a.jsx(b,{icon:a.jsx(J,{size:16}),onClick:W,block:!0,size:"large",children:"Guardar borrador"}),a.jsx(b,{icon:a.jsx(Q,{size:16}),onClick:H,block:!0,size:"large",children:"Exportar PDF"}),a.jsx(b,{icon:a.jsx(Y,{size:16}),onClick:B,block:!0,size:"large",children:"Exportar DOCX"}),a.jsx(b,{type:"primary",icon:a.jsx(ee,{size:16}),onClick:F,block:!0,size:"large",children:"Enviar por WhatsApp"})]})})})]})]})};export{de as default};
