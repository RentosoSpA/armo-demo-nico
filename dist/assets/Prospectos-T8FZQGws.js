import{r as d,a1 as D,a2 as A,j as e,T as q,b3 as Y,b4 as K,B as I,b5 as G,b6 as z,b7 as R,g as Q,a as L,a9 as V,J as F,U as W,K as X,H as T,aJ as Z,R as ee,C as se,b8 as ae,aa as re,a6 as te,b0 as oe,b9 as ie,ba as ne,bb as le,a_ as ce,s as B,F as g,f as de,b as O,I as P,D as me,S as M,bc as $,e as ue,bd as pe}from"./index-BmXdxNCh.js";import{g as H}from"./oportunidadesServiceSupabase-BNyuFQ3m.js";var he={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M872 474H286.9l350.2-304c5.6-4.9 2.2-14-5.2-14h-88.5c-3.9 0-7.6 1.4-10.5 3.9L155 487.8a31.96 31.96 0 000 48.3L535.1 866c1.5 1.3 3.3 2 5.2 2h91.5c7.4 0 10.8-9.2 5.2-14L286.9 550H872c4.4 0 8-3.6 8-8v-60c0-4.4-3.6-8-8-8z"}}]},name:"arrow-left",theme:"outlined"},xe=function(s,n){return d.createElement(D,A({},s,{ref:n,icon:he}))},je=d.forwardRef(xe),fe={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M699 353h-46.9c-10.2 0-19.9 4.9-25.9 13.3L469 584.3l-71.2-98.8c-6-8.3-15.6-13.3-25.9-13.3H325c-6.5 0-10.3 7.4-6.5 12.7l124.6 172.8a31.8 31.8 0 0051.7 0l210.6-292c3.9-5.3.1-12.7-6.4-12.7z"}},{tag:"path",attrs:{d:"M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm0 820c-205.4 0-372-166.6-372-372s166.6-372 372-372 372 166.6 372 372-166.6 372-372 372z"}}]},name:"check-circle",theme:"outlined"},ge=function(s,n){return d.createElement(D,A({},s,{ref:n,icon:fe}))},ve=d.forwardRef(ge);const{Title:be}=q,ye=({onNuevoProspecto:t,onNavigate:s,viewMode:n,onViewModeChange:o})=>e.jsxs("div",{className:"d-flex align-center justify-between mb-24",children:[e.jsxs("div",{children:[e.jsx(be,{level:2,className:"title-text mb-0",children:"Prospectos"}),e.jsx("div",{className:"paragraph-text paragraph-secondary mb-0",children:"Gestiona los prospectos interesados en tus propiedades"})]}),e.jsxs("div",{className:"d-flex align-center gap-12",children:[e.jsx(Y,{value:n,onChange:x=>o(x),options:K}),s&&e.jsx(I,{icon:e.jsx(je,{}),onClick:()=>s("Oportunidades"),children:"Volver a Oportunidades"}),e.jsx(I,{icon:e.jsx(G,{}),type:"primary",onClick:t,children:"Nuevo Prospecto"})]})]}),U=({visible:t,prospecto:s,onClose:n})=>{const[o,x]=d.useState([]),[v,N]=d.useState(!1),{empresa:j}=z();d.useEffect(()=>{t&&s&&b()},[t,s]);const b=async()=>{if(!(!s||!(j!=null&&j.id))){N(!0);try{const l=(await H(j.id)).filter(a=>a.prospecto_id===s.id);x(l)}catch(u){console.error("Error fetching opportunities:",u)}finally{N(!1)}}},c=[{key:"Exploracion",title:"Capta",icon:e.jsx(W,{className:"stage-icon"}),color:"#1890ff"},{key:"Evaluacion",title:"Evalua",icon:e.jsx(X,{className:"stage-icon"}),color:"#fa8c16"},{key:"Negociacion",title:"Negoc",icon:e.jsx(T,{className:"stage-icon"}),color:"#722ed1"},{key:"Cierre",title:"Cierre",icon:e.jsx(T,{className:"stage-icon"}),color:"#52c41a"}],h=u=>o.filter(l=>l.etapa===u);return s?e.jsx(R,{title:null,open:t,onCancel:n,footer:null,width:1200,centered:!0,className:"prospecto-opportunity-modal",children:e.jsx("div",{className:"opportunity-pipeline",children:v?e.jsx("div",{className:"text-center p-40",children:e.jsx(Q,{size:"large"})}):e.jsx("div",{className:"pipeline-stages",children:c.map((u,l)=>{const a=h(u.key),m=l===0;return e.jsxs("div",{className:"pipeline-stage",children:[e.jsxs("div",{className:"stage-header",style:{borderTopColor:u.color},children:[u.icon,e.jsx("h3",{style:{color:u.color},children:u.title})]}),e.jsx(L,{className:"stage-card",children:m?e.jsxs("div",{className:"prospect-info",children:[e.jsxs("div",{className:"prospect-header",children:[e.jsx(V,{size:48,style:{backgroundColor:u.color},children:(s.primer_nombre||s.display_name||"P").charAt(0)}),e.jsxs("div",{className:"prospect-name",children:[e.jsx("h4",{children:`${s.primer_nombre||""} ${s.segundo_nombre||""}`.trim()||s.display_name||"Prospecto"}),e.jsx("h5",{children:`${s.primer_apellido||""} ${s.segundo_apellido||""}`.trim()})]})]}),a.length>0?a.map(i=>i.propiedad&&e.jsxs("div",{className:"opportunity-item",children:[e.jsx("h6",{children:i.propiedad.titulo}),e.jsx("div",{className:"opportunity-details",children:e.jsxs("div",{className:"detail-item",children:[e.jsx(F,{size:14}),e.jsx("span",{children:i.propiedad.direccion})]})})]},i.id)):e.jsxs("div",{className:"prospect-details",children:[e.jsx("p",{className:"prospect-description",children:s.ingresos_mensuales?"Departamento moderno en Providencia":"Nuevo prospecto"}),e.jsxs("div",{className:"detail-item",children:[e.jsx(F,{size:14}),e.jsx("span",{children:"Av. Providencia 2200, Santiago"})]})]})]}):e.jsx("div",{className:"stage-content",children:a.length>0?a.map(i=>i.propiedad&&e.jsxs("div",{className:"opportunity-item",children:[e.jsx("h6",{children:i.propiedad.titulo}),e.jsxs("div",{className:"opportunity-details",children:[e.jsxs("div",{className:"detail-item",children:[e.jsx(F,{size:14}),e.jsx("span",{children:i.propiedad.direccion})]}),e.jsxs("div",{className:"opportunity-price",children:[i.propiedad.divisa," ",i.propiedad.precio.toLocaleString("es-CL",{minimumFractionDigits:0,maximumFractionDigits:0})]})]})]},i.id)):e.jsx("div",{className:"empty-stage",children:e.jsxs("div",{className:"empty-content",children:[e.jsx("span",{children:"Sin"}),e.jsx("span",{children:"oportunidades"})]})})})})]},u.key)})})})}):null},{Text:k}=q,Ne=({data:t,loading:s})=>{const[n,o]=d.useState(""),[x,v]=d.useState(null),[N,j]=d.useState(!1),b=[{key:"nuevo",title:"Captación",color:"#1890ff",icon:e.jsx(re,{})},{key:"contactado",title:"Evaluación",color:"#faad14",icon:e.jsx(te,{})},{key:"evaluado",title:"Negociación",color:"#722ed1",icon:e.jsx(oe,{})},{key:"aprobado",title:"Cierre",color:"#52c41a",icon:e.jsx(ve,{})}],c=(t==null?void 0:t.filter(a=>{var m,i,C;return((m=a.primer_nombre)==null?void 0:m.toLowerCase().includes(n.toLowerCase()))||((i=a.primer_apellido)==null?void 0:i.toLowerCase().includes(n.toLowerCase()))||((C=a.email)==null?void 0:C.toLowerCase().includes(n.toLowerCase()))}))||[],h=a=>c.filter(m=>{switch(a){case"nuevo":return!m.evaluado&&!m.aprobado;case"contactado":return m.evaluado&&!m.aprobado;case"evaluado":return m.evaluado&&m.aprobado;case"aprobado":return m.aprobado&&m.estado==="activo";default:return!1}}),u=a=>{v(a),j(!0)},l=a=>{var i,C;const m=`${((i=a.primer_nombre)==null?void 0:i.charAt(0))||""}${((C=a.primer_apellido)==null?void 0:C.charAt(0))||""}`.toUpperCase();return e.jsxs(L,{className:"cursor-pointer mb-12 animate-fade-in hover-scale",styles:{body:{padding:12}},onClick:()=>u(a),hoverable:!0,children:[e.jsx("div",{className:"d-flex align-center justify-between mb-8",children:e.jsx(V,{size:32,style:{backgroundColor:"#1890ff"},children:m||"U"})}),e.jsx("div",{className:"mb-8",children:e.jsx(k,{strong:!0,style:{fontSize:14},children:`${a.primer_nombre||""} ${a.primer_apellido||""}`.trim()||"Sin nombre"})}),e.jsx("div",{className:"mb-8",children:e.jsx(k,{type:"secondary",style:{fontSize:12},children:a.email})}),a.phone_e164&&e.jsx("div",{className:"mb-4",children:e.jsx(k,{type:"secondary",style:{fontSize:12},children:a.phone_e164})})]},a.id)};return e.jsx(L,{className:"modern-card",children:e.jsxs("div",{className:"modern-card-content",children:[e.jsxs("div",{className:"card-header",children:[e.jsx("h2",{className:"card-title",children:"Prospectos - Vista Kanban"}),e.jsx("div",{className:"card-filters",children:e.jsx(Z,{placeholder:"Buscar prospectos...",onChange:o,style:{width:300}})})]}),e.jsx(ee,{gutter:16,className:"mt-24",children:b.map(a=>{const m=h(a.key);return e.jsx(se,{xs:24,sm:12,md:6,children:e.jsx(L,{title:e.jsxs("div",{className:"d-flex align-center justify-between",children:[e.jsxs("div",{className:"d-flex align-center gap-8",children:[e.jsx("span",{style:{color:a.color},children:a.icon}),e.jsx(k,{strong:!0,children:a.title})]}),e.jsx(ae,{count:m.length,style:{backgroundColor:a.color}})]}),className:"stats-card",style:{borderRadius:12,height:"fit-content",minHeight:400},styles:{body:{padding:12,minHeight:300,display:"flex",flexDirection:"column"}},children:s?e.jsx("div",{className:"text-center p-20",children:e.jsx(k,{type:"secondary",children:"Cargando..."})}):m.length===0?e.jsx("div",{className:"text-center p-20",children:e.jsx(k,{type:"secondary",children:"Sin oportunidades"})}):e.jsx("div",{className:"flex-1",children:m.map(l)})})},a.key)})}),x&&e.jsx(U,{visible:N,prospecto:x,onClose:()=>{j(!1),v(null)}})]})})},_e=({data:t,loading:s})=>{const[n,o]=d.useState(null),[x,v]=d.useState(!1),N=c=>{o(c),v(!0)},j=()=>{v(!1),o(null)},b=[{title:"Nombre",dataIndex:"primer_nombre",render:(c,h)=>e.jsx("div",{children:`${h.primer_nombre||""} ${h.segundo_nombre||""}`.trim()})},{title:"Apellido",dataIndex:"primer_apellido",render:(c,h)=>e.jsx("div",{children:`${h.primer_apellido||""} ${h.segundo_apellido||""}`.trim()})},{title:"Email",dataIndex:"email",render:c=>e.jsx("div",{children:c})},{title:"Teléfono",dataIndex:"phone_e164",render:c=>e.jsx("div",{children:c||"-"})},{title:"Acciones",render:(c,h)=>e.jsx(le,{title:"Ver perfil",children:e.jsx(I,{type:"default",icon:e.jsx(ce,{}),onClick:u=>{u.stopPropagation(),N(h)},children:"Ver perfil"})})}];return e.jsxs("div",{className:"d-flex flex-column",children:[e.jsx(ie,{id:"prospectos-table",dataSource:t,columns:b,pagination:{pageSize:10,showSizeChanger:!0,pageSizeOptions:["10","20","50"],showTotal:(c,h)=>`${h[0]}-${h[1]} de ${c} prospectos`,position:["bottomCenter"]},loading:s,rowKey:c=>c.id||c.email||"unknown",components:{body:{row:c=>e.jsx(ne,{message:"Cambiar estado",position:"top",children:e.jsx("tr",{...c})})}},onRow:c=>({onClick:()=>N(c),style:{cursor:"pointer"}})}),n&&e.jsx(U,{visible:x,prospecto:n,onClose:j})]})},Ce=t=>{const s={};return Object.entries(t).forEach(([n,o])=>{o!==""&&o!==void 0&&o!==null&&(s[n]=o)}),s},Se=async()=>{try{const{data:t,error:s}=await B.from("prospecto").select("*").order("first_seen_at",{ascending:!1});if(s)throw s;return t||[]}catch(t){throw console.error("Error fetching prospects:",t),t}},we=async t=>{try{const s=Ce(t),{data:n,error:o}=await B.from("prospecto").insert([s]).select().single();if(o)throw o;return n}catch(s){throw console.error("Error creating prospect:",s),s}},{Option:y}=M,Pe=({open:t,onClose:s,onCreated:n})=>{const[o]=g.useForm(),[x,v]=d.useState(0),[N,j]=d.useState(!1),{message:b}=de.useApp(),c=async()=>{try{const l=x===0?["primerNombre","primerApellido","email","fechaNacimiento"]:["codigoTelefonico","telefono","tipoDocumento","documento"];await o.validateFields(l),v(a=>a+1)}catch(l){console.error("Validation error:",l)}},h=()=>v(l=>l-1),u=async()=>{var l,a,m,i,C,S,w,E;try{await o.validateFields(),j(!0);const r=o.getFieldsValue(!0),_=(l=r.telefono)==null?void 0:l.toString().trim();if(!_||_.length<7||_.length>15){b.error("El número de teléfono debe tener entre 7 y 15 dígitos"),j(!1);return}const p={source:"manual",phone_e164:`+${r.codigo_telefonico}${_}`,email:((a=r.email)==null?void 0:a.trim())||void 0,codigo_telefonico:r.codigo_telefonico,fecha_nacimiento:((m=r.fecha_nacimiento)==null?void 0:m.format("YYYY-MM-DD"))||void 0,genero:r.genero||void 0,documento:((i=r.documento)==null?void 0:i.trim())||void 0,tipo_documento:r.tipo_documento||void 0,primer_apellido:(C=r.primer_apellido)==null?void 0:C.trim(),segundo_apellido:((S=r.segundo_apellido)==null?void 0:S.trim())||void 0,primer_nombre:(w=r.primer_nombre)==null?void 0:w.trim(),segundo_nombre:((E=r.segundo_nombre)==null?void 0:E.trim())||void 0,situacion_laboral:r.situacion_laboral||void 0,ingresos_mensuales:r.ingresos_mensuales||void 0,egresos_mensuales:r.egresos_mensuales||void 0};await we(p),b.success("Prospecto agregado correctamente"),o.resetFields(),v(0),s(),n()}catch(r){console.error("Error al guardar:",r);let _="Error al crear el prospecto";(r==null?void 0:r.code)==="23505"?_="Este teléfono o email ya está registrado":(r==null?void 0:r.code)==="22007"?_="Formato de fecha inválido":(r==null?void 0:r.code)==="23502"?_="Faltan campos obligatorios":r!=null&&r.message&&(_=r.message),b.error(_)}finally{j(!1)}};return d.useEffect(()=>{t&&(o.resetFields(),v(0))},[t,o]),e.jsxs(R,{open:t,onCancel:s,footer:null,title:"Nuevo Prospecto",className:"p-24",width:800,afterClose:()=>{o.resetFields(),v(0)},children:[e.jsxs(O,{current:x,size:"small",className:"mb-24",children:[e.jsx(O.Step,{title:"Información Personal"}),e.jsx(O.Step,{title:"Contacto y Documentos"}),e.jsx(O.Step,{title:"Información Adicional"})]}),e.jsxs(g,{layout:"vertical",form:o,children:[x===0&&e.jsxs(e.Fragment,{children:[e.jsx(g.Item,{name:"primerNombre",label:"Primer Nombre",rules:[{required:!0,message:"El primer nombre es requerido"}],children:e.jsx(P,{})}),e.jsx(g.Item,{name:"segundoNombre",label:"Segundo Nombre",children:e.jsx(P,{})}),e.jsx(g.Item,{name:"primerApellido",label:"Primer Apellido",rules:[{required:!0,message:"El primer apellido es requerido"}],children:e.jsx(P,{})}),e.jsx(g.Item,{name:"segundoApellido",label:"Segundo Apellido",children:e.jsx(P,{})}),e.jsx(g.Item,{name:"email",label:"Email",rules:[{required:!0,message:"El email es requerido"},{type:"email",message:"Por favor ingresa un email válido"}],children:e.jsx(P,{})}),e.jsx(g.Item,{name:"fechaNacimiento",label:"Fecha de Nacimiento",rules:[{required:!0,message:"La fecha de nacimiento es requerida"}],children:e.jsx(me,{className:"w-full"})}),e.jsx(g.Item,{name:"genero",label:"Género",rules:[{required:!0,message:"El género es requerido"}],children:e.jsxs(M,{placeholder:"Selecciona el género",children:[e.jsx(y,{value:"Masculino",children:"Masculino"}),e.jsx(y,{value:"Femenino",children:"Femenino"}),e.jsx(y,{value:"Otro",children:"Otro"}),e.jsx(y,{value:"Prefiero no decir",children:"Prefiero no decir"})]})})]}),x===1&&e.jsxs(e.Fragment,{children:[e.jsx(g.Item,{name:"codigoTelefonico",label:"Código Telefónico",rules:[{required:!0,message:"El código telefónico es requerido"}],children:e.jsx($,{className:"w-full",placeholder:"56"})}),e.jsx(g.Item,{name:"telefono",label:"Teléfono",rules:[{required:!0,message:"El teléfono es requerido"}],children:e.jsx($,{className:"w-full"})}),e.jsx(g.Item,{name:"tipoDocumento",label:"Tipo de Documento",rules:[{required:!0,message:"El tipo de documento es requerido"}],children:e.jsxs(M,{placeholder:"Selecciona el tipo de documento",children:[e.jsx(y,{value:"RUT",children:"RUT"}),e.jsx(y,{value:"Pasaporte",children:"Pasaporte"}),e.jsx(y,{value:"Cedula",children:"Cédula de Identidad"}),e.jsx(y,{value:"Otro",children:"Otro"})]})}),e.jsx(g.Item,{name:"documento",label:"Número de Documento",rules:[{required:!0,message:"El número de documento es requerido"}],children:e.jsx(P,{})})]}),x===2&&e.jsxs(e.Fragment,{children:[e.jsx(g.Item,{name:"situacionLaboral",label:"Situación Laboral",children:e.jsxs(M,{placeholder:"Selecciona la situación laboral",children:[e.jsx(y,{value:"Empleado",children:"Empleado"}),e.jsx(y,{value:"Independiente",children:"Independiente"}),e.jsx(y,{value:"Desempleado",children:"Desempleado"}),e.jsx(y,{value:"Estudiante",children:"Estudiante"}),e.jsx(y,{value:"Jubilado",children:"Jubilado"}),e.jsx(y,{value:"Otro",children:"Otro"})]})}),e.jsx(g.Item,{name:"ingresosMensuales",label:"Ingresos Mensuales (CLP)",children:e.jsx($,{className:"w-full",formatter:l=>`$ ${l}`.replace(/\B(?=(\d{3})+(?!\d))/g,","),parser:l=>l.replace(/\$\s?|(,*)/g,"")})}),e.jsx(g.Item,{name:"egresosMensuales",label:"Egresos Mensuales (CLP)",children:e.jsx($,{className:"w-full",formatter:l=>`$ ${l}`.replace(/\B(?=(\d{3})+(?!\d))/g,","),parser:l=>l.replace(/\$\s?|(,*)/g,"")})})]}),e.jsxs("div",{className:"d-flex justify-between mt-24",children:[x>0&&e.jsx(I,{onClick:h,disabled:N,children:"Anterior"}),x<2?e.jsx(I,{type:"primary",onClick:c,disabled:N,children:"Siguiente"}):e.jsx(I,{type:"primary",onClick:u,loading:N,children:"Crear Prospecto"})]})]})]})},Ee=()=>{var _;const t=ue(),s=pe(),{empresa:n}=z(),[o,x]=d.useState([]),[v,N]=d.useState([]),[j,b]=d.useState(!0),[c,h]=d.useState(!1),[u,l]=d.useState(!1),[a,m]=d.useState("kanban"),i=(_=s.state)==null?void 0:_.filter,C=p=>{const J={Tablero:"/tablero",Oportunidades:"/oportunidades",Propiedades:"/propiedades",Prospectos:"/prospectos",Propietarios:"/propietarios",Contratos:"/contratos",Reportes:"/reportes",Visitas:"/calendario"}[p]||"/tablero";t(J)},S=d.useCallback(async()=>{b(!0);try{const p=await Se();x(p)}catch(p){console.error(p)}finally{b(!1)}},[]),w=d.useCallback(async()=>{b(!0);try{const p=await H((n==null?void 0:n.id)||"");N(p)}catch(p){console.error(p)}finally{b(!1)}},[n==null?void 0:n.id]);d.useEffect(()=>{i?(l(!0),w()):(l(!1),S())},[i,w,S]);const E=v.filter(p=>i?i.etapa?p.etapa===i.etapa:i.status?p.status===i.status:!0:!0),r=d.useMemo(()=>u?E.map(p=>{const f=p.prospecto;return{id:p.id,source:"opportunity",phone_e164:(f==null?void 0:f.phone_e164)||"+56900000000",email:f==null?void 0:f.email,primer_nombre:f==null?void 0:f.primer_nombre,primer_apellido:f==null?void 0:f.primer_apellido,display_name:f==null?void 0:f.display_name,estado:p.etapa,first_seen_at:p.created_at,last_seen_at:p.updated_at}}):o,[u,E,o]);return e.jsxs("div",{className:"prospectos-page",children:[e.jsx(ye,{onNuevoProspecto:()=>h(!0),onNavigate:C,viewMode:a,onViewModeChange:m}),a==="kanban"?e.jsx(Ne,{data:r,loading:j}):e.jsx(_e,{data:r,loading:j}),e.jsx(Pe,{open:c,onClose:()=>h(!1),onCreated:u?w:S})]})};export{Ee as default};
